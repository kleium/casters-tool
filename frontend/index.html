<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caster's Tool — FRC Event Dashboard</title>
    <link rel="icon" type="image/svg+xml" href="/favicon.svg">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <header>
        <div class="header-brand">
            <svg class="brand-icon" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/><line x1="12" y1="22" x2="12" y2="15.5"/><polyline points="22 8.5 12 15.5 2 8.5"/><polyline points="2 15.5 12 8.5 22 15.5"/><line x1="12" y1="2" x2="12" y2="8.5"/></svg>
            <div class="brand-text">
                <h1>Caster's Tool</h1>
                <span class="brand-sub">FRC Event Dashboard</span>
            </div>
        </div>
        <div class="header-right">
            <div id="event-badge" class="hidden"></div>
            <div class="settings-wrapper">
                <button class="settings-btn" onclick="toggleSettings()" title="Settings">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
                </button>
                <div id="settings-menu" class="settings-menu hidden">
                    <div class="settings-title">Settings</div>
                    <label class="settings-toggle">
                        <input type="checkbox" id="toggle-theme" onchange="toggleTheme(this.checked)">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Light mode</span>
                    </label>
                    <label class="settings-toggle">
                        <input type="checkbox" id="toggle-highlight-foreign" onchange="toggleHighlightForeign(this.checked)">
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Highlight International Teams</span>
                    </label>
                </div>
            </div>
        </div>
    </header>

    <div class="tabs-wrap">
    <nav class="tabs">
        <button class="tab active" data-tab="event">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            Events
        </button>
        <button class="tab" data-tab="history">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            History
        </button>
        <button class="tab" data-tab="rankings">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
            Rankings
        </button>
        <button class="tab" data-tab="summary">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
            Summary
        </button>
        <button class="tab" data-tab="playbyplay">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>
            Play by Play
        </button>
        <button class="tab" data-tab="breakdown">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Breakdown
        </button>
        <button class="tab" data-tab="alliance">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
            Alliances
        </button>
        <button class="tab" data-tab="playoff">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5C7 4 9 7 12 7s5-3 7.5-3a2.5 2.5 0 0 1 0 5H18"/><path d="M18 15h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M6 15H4.5a2.5 2.5 0 0 1 0 5H6"/><line x1="6" y1="9" x2="6" y2="15"/><line x1="18" y1="9" x2="18" y2="15"/><path d="M6 20h12a2 2 0 0 0 2-2v-2H4v2a2 2 0 0 0 2 2z"/></svg>
            Playoffs
        </button>
        <button class="tab" data-tab="team">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
            Team Lookup
        </button>
    </nav>
    </div>

    <main>
        <!-- ═══ Event Selection ═══ -->
        <section id="tab-event" class="tab-content active">

            <!-- Active event banner -->
            <div id="active-event-banner" class="active-event-banner hidden">
                <div class="aeb-left">
                    <span class="aeb-dot"></span>
                    <div class="aeb-info">
                        <span id="aeb-name" class="aeb-name"></span>
                        <span id="aeb-meta" class="aeb-meta"></span>
                    </div>
                </div>
                <div class="aeb-right">
                    <span id="aeb-cache-badge" class="aeb-cache-badge hidden" title="Loaded from saved cache"></span>
                    <button id="btn-save-event" class="btn-save-event" onclick="saveCurrentEvent()" title="Save event for instant loading">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        <span id="save-event-label">Save Event</span>
                    </button>
                </div>
            </div>

            <!-- Current season quick-select -->
            <div class="event-section-card">
                <div class="event-section-header">
                    <h3 class="event-section-title">2026 Season Events</h3>
                    <div class="season-header-right">
                        <span id="season-count-badge" class="season-count-badge"></span>
                        <button id="season-refresh-btn" class="season-refresh-btn" onclick="refreshSeasonEventsFromAPI()" title="Refresh event list from TBA">↻</button>
                    </div>
                </div>
                <p class="event-section-desc">Select an event from the current season. Filter by region or week, or search by name.</p>
                <div class="season-controls">
                    <div class="season-filter-row">
                        <select id="season-filter-region" onchange="filterSeasonEvents()">
                            <option value="">All Regions</option>
                        </select>
                        <select id="season-filter-week" onchange="filterSeasonEvents()">
                            <option value="">All Weeks</option>
                        </select>
                    </div>
                    <div class="season-search-wrap">
                        <input type="text" id="season-search"
                               placeholder="Type to search events…"
                               autocomplete="off"
                               oninput="filterSeasonEvents()" />
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
                        <div id="season-dropdown" class="season-dropdown hidden">
                            <div id="season-dropdown-list"></div>
                        </div>
                    </div>
                </div>
                <div id="season-status" class="season-status"></div>
            </div>

            <!-- Manual event code entry (collapsed by default) -->
            <div class="event-section-card event-section-alt">
                <div class="event-section-header clickable" onclick="toggleManualEntry()">
                    <h3 class="event-section-title">Search by Event Code</h3>
                    <span id="manual-toggle-icon" class="collapse-icon">▼</span>
                </div>
                <div id="manual-entry-body" class="manual-entry-body collapsed">
                    <p class="event-section-desc">Load any event from any year using its TBA event key.</p>
                    <div class="input-row">
                        <input type="text" id="event-year"
                               placeholder="Year (e.g. 2025)" class="input-sm" />
                        <input type="text" id="event-code"
                               placeholder="Event code (e.g. txda)" />
                        <button id="btn-load-event" onclick="loadEvent()">Load Event</button>
                    </div>
                </div>
            </div>

            <!-- Saved Events quick-access -->
            <div id="saved-events-card" class="event-section-card saved-events-card hidden">
                <div class="event-section-header">
                    <h3 class="event-section-title">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="vertical-align:-2px; margin-right:4px"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                        Saved Events
                    </h3>
                </div>
                <div id="saved-events-list" class="saved-events-list"></div>
            </div>
        </section>

        <!-- ═══ Rankings & Teams ═══ -->
        <section id="tab-rankings" class="tab-content">
            <p id="rankings-empty" class="empty">
                Load an event first to see rankings and team list.
            </p>
            <div id="rankings-container" class="hidden">
                <div id="event-teams"></div>
            </div>
        </section>

        <!-- ═══ Event Summary ═══ -->
        <section id="tab-summary" class="tab-content">
            <p id="summary-empty" class="empty">
                Load an event first, then switch here for the event summary.
            </p>
            <div id="summary-container" class="hidden">
                <div class="summary-header">
                    <h2 id="summary-title"></h2>
                    <button class="summary-refresh-btn" onclick="refreshSummaryStats()">↻ Refresh Stats</button>
                </div>

                <!-- Demographics row -->
                <div class="summary-stats-row" id="summary-demographics"></div>

                <!-- Hall of Fame & Impact Award -->
                <div id="summary-hof" class="summary-card hidden">
                    <h3>Hall of Fame Teams</h3>
                    <div id="summary-hof-list"></div>
                </div>
                <div id="summary-impact" class="summary-card hidden">
                    <h3>Impact Award Finalists</h3>
                    <div id="summary-impact-list"></div>
                </div>

                <!-- Prior partnerships & rivalries -->
                <div id="summary-history" class="summary-card hidden">
                    <div class="summary-card-header" onclick="toggleConnections()">
                        <h3>Prior Playoff Connections</h3>
                        <span id="conn-toggle-icon" class="collapse-icon">▲</span>
                    </div>
                    <div id="summary-history-body">
                        <p class="summary-card-desc">Teams at this event who have partnered or competed against each other in past playoff matches.</p>
                        <div class="conn-toolbar">
                            <input type="text" id="conn-team-search" class="conn-search-input" placeholder="Filter by team #…" oninput="applyConnFilters()">
                            <div class="conn-filter-bar">
                                <button class="conn-filter-btn active" data-conn-filter="all" onclick="event.stopPropagation(); filterConnections('all', this)">All</button>
                                <button class="conn-filter-btn" data-conn-filter="partners" onclick="event.stopPropagation(); filterConnections('partners', this)">Partners</button>
                                <button class="conn-filter-btn" data-conn-filter="opponents" onclick="event.stopPropagation(); filterConnections('opponents', this)">Opponents</button>
                                <span class="conn-filter-sep"></span>
                                <button class="conn-filter-btn" data-conn-filter="winners" onclick="event.stopPropagation(); filterConnections('winners', this)">Winners</button>
                                <button class="conn-filter-btn" data-conn-filter="finalists" onclick="event.stopPropagation(); filterConnections('finalists', this)">Finalists</button>
                            </div>
                        </div>
                        <div class="conn-toolbar conn-toolbar-secondary">
                            <label class="conn-range-toggle" onclick="event.stopPropagation()">
                                <span class="conn-range-side active">Past 3 seasons</span>
                                <input type="checkbox" id="conn-alltime-toggle" onchange="toggleConnRange(this.checked)">
                                <span class="conn-toggle-slider"></span>
                                <span class="conn-range-side">All time</span>
                            </label>
                            <div class="conn-sort-bar" onclick="event.stopPropagation()">
                                <span class="conn-sort-label">Sort:</span>
                                <button class="conn-sort-btn active" data-conn-sort="most" onclick="setConnSort('most', this)">Most connections</button>
                                <button class="conn-sort-btn" data-conn-sort="recent" onclick="setConnSort('recent', this)">Most recent</button>
                                <button class="conn-sort-btn" data-conn-sort="oldest" onclick="setConnSort('oldest', this)">Oldest</button>
                            </div>
                        </div>
                        <div id="summary-history-list"></div>
                    </div>
                </div>

                <!-- Top 3 score contributors -->
                <div id="summary-top-scorers" class="summary-card hidden">
                    <h3>Top Score Contributors</h3>
                    <p class="summary-card-desc">Highest individual OPR (score contribution) at this event so far.</p>
                    <div id="summary-top-list"></div>
                </div>
            </div>
            <div id="summary-loading" class="hidden loading-msg">
                Analysing event data …
            </div>
        </section>

        <!-- ═══ Play by Play ═══ -->
        <section id="tab-playbyplay" class="tab-content">
            <p id="pbp-empty" class="empty">
                Load an event first, then switch here for the play-by-play view.
            </p>
            <div id="pbp-container" class="hidden">
                <div class="pbp-topbar">
                    <button class="pbp-nav-btn" onclick="pbpPrev()" title="Previous Match">◀ Previous</button>
                    <div class="pbp-match-info">
                        <div id="pbp-match-label" class="pbp-match-label"></div>
                        <div class="pbp-selector-row">
                            <select id="pbp-match-select" onchange="pbpGoTo(this.value)"></select>
                        </div>
                    </div>
                    <button class="pbp-nav-btn" onclick="pbpNext()" title="Next Match">Next ▶</button>
                </div>
                <div id="pbp-arena" class="pbp-arena"></div>
                <div id="pbp-footer" class="pbp-footer"></div>
            </div>
        </section>

        <!-- ═══ Score Breakdown ═══ -->
        <section id="tab-breakdown" class="tab-content">
            <p id="bd-empty" class="empty">
                Load an event first, then switch here for detailed score breakdowns.
            </p>
            <div id="bd-container" class="hidden">
                <div class="pbp-topbar">
                    <button class="pbp-nav-btn" onclick="bdPrev()" title="Previous Match">◀ Previous</button>
                    <div class="pbp-match-info">
                        <div id="bd-match-label" class="pbp-match-label"></div>
                        <div class="pbp-selector-row">
                            <select id="bd-match-select" onchange="bdGoTo(this.value)"></select>
                        </div>
                    </div>
                    <button class="pbp-nav-btn" onclick="bdNext()" title="Next Match">Next ▶</button>
                </div>
                <div id="bd-spotlight" class="bd-spotlight hidden"></div>
                <div id="bd-status" class="bd-status"></div>
                <div id="bd-content" class="bd-content"></div>
            </div>
        </section>

        <!-- ═══ Playoffs ═══ -->
        <section id="tab-playoff" class="tab-content">
            <p id="playoff-empty" class="empty">
                Load an event first, then switch here to see playoff matches.
            </p>
            <div id="playoff-bracket"></div>
        </section>

        <!-- ═══ Alliance Selection ═══ -->
        <section id="tab-alliance" class="tab-content">
            <p id="alliance-empty" class="empty">
                Load an event first, then switch here to view alliances.
            </p>
            <div id="alliance-loading" class="hidden loading-msg">
                Fetching alliance data &amp; partnership history …
            </div>
            <div id="alliance-toolbar" class="alliance-toolbar hidden">
                <label class="toggle-label"><input type="checkbox" id="alliance-toggle-avatars" checked onchange="toggleAllianceAvatars(this.checked)"> Avatars</label>
                <label class="toggle-label"><input type="checkbox" id="alliance-toggle-names" onchange="toggleAllianceNames(this.checked)"> Team Names</label>
                <label class="toggle-label"><input type="checkbox" id="alliance-toggle-dpr" onchange="toggleAllianceDpr(this.checked)"> DPR / CCWM</label>
                <label class="toggle-label"><input type="checkbox" id="alliance-toggle-playoff" onchange="toggleAlliancePlayoff(this.checked)"> Playoff Status</label>
            </div>
            <div id="alliance-grid"></div>
        </section>

        <!-- ═══ Region & Event History ═══ -->
        <section id="tab-history" class="tab-content">
            <p id="history-empty" class="empty">
                Load an event first, then switch here for region & event history.
            </p>
            <div id="history-loading" class="hidden loading-msg">
                Loading event history …
            </div>
            <div id="history-container" class="hidden">
                <div class="history-panels">
                    <!-- Region Facts panel -->
                    <div class="history-panel" id="history-region">
                        <h3 class="history-panel-title" id="history-region-title">Region Facts</h3>
                        <div id="history-region-body"></div>
                    </div>
                    <!-- Event History panel -->
                    <div class="history-panel" id="history-event">
                        <h3 class="history-panel-title" id="history-event-title">Event History</h3>
                        <div id="history-event-body"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ═══ Team Lookup ═══ -->
        <section id="tab-team" class="tab-content">
            <div class="input-row">
                <input type="text" id="team-number"
                       placeholder="Enter team number (e.g. 148)" />
                <input type="text" id="team-year"
                       placeholder="Year (blank = current)" class="input-sm"/>
                <button onclick="loadTeam()">Look Up</button>
            </div>
            <div id="team-stats"></div>

            <div class="h2h-section">
                <div class="h2h-title-bar">
                    <h3>Head-to-Head Playoff History</h3>
                    <label class="pbp-conn-range-toggle" onclick="event.stopPropagation()">
                        <span class="conn-range-side h2h-range-side active">Past 3 Seasons</span>
                        <input type="checkbox" id="h2h-all-time-toggle" onchange="toggleH2HRange(this.checked)">
                        <span class="conn-toggle-slider"></span>
                        <span class="conn-range-side h2h-range-side">All time</span>
                    </label>
                </div>
                <div class="input-row">
                    <input type="text" id="h2h-team-a" placeholder="Team A" />
                    <span class="vs-label">vs</span>
                    <input type="text" id="h2h-team-b" placeholder="Team B" />
                    <button onclick="loadH2H()">Check</button>
                </div>
                <div id="h2h-results"></div>
            </div>
        </section>
    </main>

    <div id="loading-overlay" class="hidden">
        <div class="spinner"></div>
        <p>Loading …</p>
    </div>

    <!-- ═══ Comparison Modal ═══ -->
    <div id="compare-overlay" class="compare-overlay hidden" onclick="if(event.target===this)closeCompare()">
        <div class="compare-modal">
            <div class="compare-modal-header">
                <h2 id="compare-title">Team Comparison</h2>
                <button class="compare-close-btn" onclick="closeCompare()" title="Close">&times;</button>
            </div>
            <div id="compare-body" class="compare-body">
                <p class="empty">Select teams to compare.</p>
            </div>
        </div>
    </div>

    <!-- ═══ Floating Compare Bar (for table selection) ═══ -->
    <div id="compare-bar" class="compare-bar hidden">
        <span id="compare-bar-count">0 teams selected</span>
        <button onclick="launchCompareFromSelection()">Compare</button>
        <button class="compare-bar-clear" onclick="clearCompareSelection()">Clear</button>
    </div>

    <script src="/js/api.js"></script>
    <script src="/js/cache.js"></script>
    <script src="/js/app.js"></script>

    <footer class="site-footer">
        <div class="footer-top">
            <span>Caster's Tool</span>
            <span class="footer-sep">·</span>
            <span>Built by Gürsel for FIRST Community</span>
            <span class="footer-sep">·</span>
            <span class="footer-version">v1.0</span>
        </div>
        <div class="footer-attribution" id="footer-status">
            <span class="status-item" id="status-tba" title="The Blue Alliance API">
                <span class="status-dot status-checking"></span>
                Powered by <a href="https://www.thebluealliance.com" target="_blank" rel="noopener">The Blue Alliance</a>
            </span>
            <span class="footer-sep">·</span>
            <span class="status-item" id="status-frc" title="FIRST FRC Events API">
                <span class="status-dot status-checking"></span>
                Event Data provided by <a href="https://frc-events.firstinspires.org/services/API" target="_blank" rel="noopener"><em>FIRST</em></a>
            </span>
        </div>
    </footer>
</body>
</html>
